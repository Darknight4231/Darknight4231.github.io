<!DOCTYPE html>
<head>
<title>VoiceModder</title>

</head>
<body>

  <p id="um">VoiceModulator hopefully.</p>

  <script src="impulseresponse.js"></script>
  <script>


  //let oof = new Audio("oof.mp3");
  //document.addEventListener('keydown', keyhandler);

  let audioContext;

  try {
     audioContext =
      new (window.AudioContext || window.webkitAudioContext)();
      console.log("AudioContext Defined, starting.");
  } catch (error) {
    console.log("AudioContext startup unsuccessful");
    window.alert(
      `Sorry, but your browser doesn't support the Web Audio API!`
    );
  }

/*
Defaults for all biquadFilter properties
biquadFilter.detune = 0;
biquadFilter.q = 1;
biquadFilter.frequency.value = 350;
biquadFilter.gain.value = 0;
*/

if (navigator.mediaDevices) {
  console.log('navigator exists');
    navigator.mediaDevices.getUserMedia({audio:true}).then(function (stream) {
      console.log('audioexists');


            let audioCtx = new AudioContext();
            let source = audioCtx.createMediaStreamSource(stream);
            let reverbNode = audioCtx.createConvolver();
            let biquadFilter = audioCtx.createBiquadFilter();
            biquadFilter.type = 'highpass';
            biquadFilter.detune = 0;
            biquadFilter.q = 1;
            biquadFilter.frequency.value = 180;
            biquadFilter.gain.value = 0;

function base64ToArrayBuffer(base64) {
    var binaryString = window.atob(base64);
    var len = binaryString.length;
    var bytes = new Uint8Array(len);
    for (var i = 0; i < len; i++)        {
        bytes[i] = binaryString.charCodeAt(i);
    }
    return bytes.buffer;
}
  //the 'impulseResponse' is a really long string that is somehow both Base64 and Binary.
  //What is Base64??

  var reverbSoundArrayBuffer = base64ToArrayBuffer(impulseResponse);

  // .decodeAudioData(ArrayBuffer, Success function, Failure function)
  audioContext.decodeAudioData(reverbSoundArrayBuffer,
    function(buffer) {
      reverbNode.buffer = buffer;
    },
    function(e) {
      alert("Error when decoding audio data" + e.err);
    }
  );
  console.log(base64ToArrayBuffer(impulseResponse));


            source.connect(reverbNode);
            //reverbNode.connect(biquadFilter);
            reverbNode.connect(audioCtx.destination);
            //source.connect(biquadFilter);
            //biquadFilter.connect(audioCtx.destination);
      });
    };

</script>
</body>
